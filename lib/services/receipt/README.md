# Универсальный парсер чеков

Бесплатное решение для сканирования и парсинга чеков на всех языках и для всех стран.

## Особенности

- ✅ **Бесплатно** - использует Google ML Kit (офлайн, без API ключей)
- ✅ **Универсально** - поддерживает множество языков и форматов чеков
- ✅ **Офлайн** - работает без интернета
- ✅ **Многоязычность** - автоматическое определение языка и валюты

## Компоненты

### 1. OCRService
Сервис для распознавания текста с изображений чеков.

```dart
final ocrService = OCRService();
final text = await ocrService.recognizeTextFromFile(imageFile);
```

### 2. ReceiptParser
Универсальный парсер, который извлекает структурированные данные из текста чека.

```dart
final parser = ReceiptParser();
final draft = parser.parseReceiptText(
  text: recognizedText,
  imagePath: imagePath,
);
```

### 3. ReceiptScanningService
Основной сервис, объединяющий OCR и парсинг.

```dart
final service = ReceiptScanningService();

// Сканирование с файла
final draft = await service.scanReceiptFromFile(imageFile);

// Сканирование с XFile (из image_picker)
final image = await ImagePicker().pickImage(source: ImageSource.camera);
if (image != null) {
  final draft = await service.scanReceiptFromXFile(image);
}
```

## Поддерживаемые языки

Парсер поддерживает автоматическое определение языка и извлечение данных для следующих языков:

### Европейские языки
- **Английский** (en) - полная поддержка
- **Русский** (ru) - полная поддержка
- **Немецкий** (de) - полная поддержка
- **Французский** (fr) - полная поддержка
- **Испанский** (es) - полная поддержка
- **Итальянский** (it) - полная поддержка
- **Португальский** (pt) - полная поддержка
- **Греческий** (el) - базовая поддержка

### Азиатские языки
- **Китайский** (zh) - полная поддержка
- **Японский** (ja) - полная поддержка
- **Корейский** (ko) - базовая поддержка
- **Тайский** (th) - базовая поддержка

### Ближневосточные языки
- **Арабский** (ar) - базовая поддержка
- **Иврит** (he) - базовая поддержка

### Кавказские языки
- **Армянский** (hy) - базовая поддержка
  - ⚠️ Примечание: Google ML Kit может распознавать армянский текст как латиницу. Парсер использует умную логику для извлечения товаров даже из частично распознанного текста.

### Примечания
- Автоматическое определение языка работает на основе Unicode диапазонов символов
- Для латинского текста используется определение по ключевым словам
- Парсер извлекает товары, цены и другие данные даже при неточном распознавании текста
- И другие...

## Извлекаемые данные

- Название магазина
- Адрес магазина
- Дата покупки
- Список товаров (название, количество, цена)
- Общая сумма
- Сумма без налогов
- Налоги
- Сервисный сбор
- Скидки
- Метод оплаты
- Валюта (автоматическое определение)

## Пример использования

```dart
import 'package:image_picker/image_picker.dart';
import 'package:spendings_tracking_app/services/receipt/receipt_scanning_service.dart';

// Создаем сервис
final scanningService = ReceiptScanningService();

// Выбираем изображение
final imagePicker = ImagePicker();
final image = await imagePicker.pickImage(source: ImageSource.camera);

if (image != null) {
  // Сканируем чек
  final receiptDraft = await scanningService.scanReceiptFromXFile(image);
  
  // Проверяем, требуется ли ручная проверка
  if (receiptDraft.requiresReview) {
    // Показываем пользователю для проверки
    print('Требуется проверка: ${receiptDraft.rawText}');
  }
  
  // Используем данные
  print('Магазин: ${receiptDraft.store?.name}');
  print('Сумма: ${receiptDraft.total} ${receiptDraft.currency}');
  print('Товаров: ${receiptDraft.items.length}');
  
  for (final item in receiptDraft.items) {
    print('  - ${item.name}: ${item.quantity}x ${item.unitPrice}');
  }
}

// Не забываем освободить ресурсы
scanningService.dispose();
```

## Обработка ошибок

Парсер использует эвристики и может не всегда точно распознать все данные. 
Если `requiresReview == true`, рекомендуется показать пользователю распознанный текст 
для ручной проверки и корректировки.

## Примечания

- Парсер работает лучше с четкими, хорошо освещенными изображениями
- Для лучших результатов рекомендуется предварительная обработка изображения
- Некоторые форматы чеков могут требовать дополнительной настройки парсера

